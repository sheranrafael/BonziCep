#!/usr/bin/env ruby

require 'bonzi_cep'
require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Uso: bonzi_cep [opções]"

  opts.on("-g", "--gerar", "Gerar um CEP aleatório") do
    options[:gerar] = true
  end

  opts.on("-eESTADO", "--estado=ESTADO", "Gerar CEP para um estado específico") do |estado|
    options[:estado] = estado.upcase
  end

  opts.on("-cCEP", "--consulta=CEP", "Consultar um CEP") do |cep|
    options[:consulta] = cep
  end

  opts.on("-vCEP", "--validar=CEP", "Validar um CEP") do |cep|
    options[:validar] = cep
  end

  opts.on("-l", "--lista", "Listar estados suportados") do
    options[:lista] = true
  end

  opts.on("-h", "--help", "Mostrar ajuda") do
    puts opts
    puts "\nExemplos:"
    puts "  bonzi_cep -g                 # Gera CEP aleatório"
    puts "  bonzi_cep -g -e SP           # Gera CEP para São Paulo"
    puts "  bonzi_cep -c 01001-000       # Consulta um CEP"
    puts "  bonzi_cep -v 12345-678       # Valida um CEP"
    puts "  bonzi_cep -l                 # Lista estados suportados"
    exit
  end
end.parse!

if options[:gerar]
  begin
    if options[:estado]
      resultado = BonziCEP.gerar_para_estado(options[:estado])
      puts "\n📍 CEP Gerado para #{resultado[:estado]}:"
    else
      resultado = BonziCEP.gerar
      puts "\n📍 CEP Aleatório Gerado:"
    end
    
    puts "├─ CEP: #{resultado[:cep]}"
    puts "├─ Estado: #{resultado[:estado]}"
    puts "└─ Região: #{resultado[:regiao]}"
    
  rescue BonziCEP::EstadoInvalido => e
    puts "\n❌ Erro: #{e.message}"
    puts "Use 'bonzi_cep -l' para ver estados válidos"
  end
  
elsif options[:consulta]
  begin
    resultado = BonziCEP.consultar(options[:consulta])
    puts "\n🔍 Consulta CEP #{resultado[:cep]}:"
    puts "├─ Estado: #{resultado[:estado]}"
    puts "└─ Região: #{resultado[:regiao]}"
  rescue BonziCEP::CEPInvalido => e
    puts "\n❌ Erro: #{e.message}"
  end
  
elsif options[:validar]
  valido = BonziCEP.valido?(options[:validar])
  puts "\n#{valido ? '✅' : '❌'} O CEP #{options[:validar]} é #{valido ? 'válido' : 'inválido'}"
  
  if valido
    begin
      estado = BonziCEP.consultar(options[:validar])[:estado]
      puts "├─ Pertence ao estado: #{estado}"
      puts "└─ Região: #{BonziCEP::REGIOES_POR_ESTADO[estado]}"
    rescue
      puts "└─ (Estado não identificado)"
    end
  end
  
elsif options[:lista]
  puts "\n🇧🇷 Estados Suportados:"
  BonziCEP.estados_suportados.each do |estado|
    puts "├─ #{estado}: #{BonziCEP::REGIOES_POR_ESTADO[estado]}"
  end
  puts "└─ Total: #{BonziCEP.estados_suportados.size} estados"
  
else
  puts "Use -h para ver as opções disponíveis"
end